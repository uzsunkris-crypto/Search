<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Payment — SEARCH</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <main class="card" style="max-width:520px;margin:30px auto">
    <div style="text-align:center">
      <div class="brand-big" style="font-size:28px">SEARCH</div>
      <p class="muted">Pay ₦100 for today. Access lasts until midnight (calendar date).</p>
    </div>

    <div style="margin-top:12px" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><div style="font-weight:800">Daily Access</div><div class="muted small">Valid for the current calendar date</div></div>
        <div style="font-size:20px;font-weight:900">₦100</div>
      </div>

      <div style="margin-top:14px">
        <button id="pay-now" class="primary full">Pay ₦100 for today</button>
      </div>
    </div>

    <div id="pay-status" style="margin-top:12px;display:none" class="card muted small">Waiting for payment verification...</div>
    <div style="margin-top:10px;text-align:center" class="muted small">We verify payments securely. Do not share OTPs.</div>
  </main>

  <script src="https://js.paystack.co/v1/inline.js"></script>
  <script>
    async function q(id){return document.getElementById(id)}
    document.getElementById('pay-now').addEventListener('click', async ()=>{
      if(!window.FIREBASE_CLIENT_CONFIG) return alert('Firebase not configured');
      if(!firebase.apps.length) firebase.initializeApp(window.FIREBASE_CLIENT_CONFIG);
      const auth = firebase.auth();
      const user = auth.currentUser;
      if(!user) return alert('Sign in first');
      if(!user.emailVerified) return alert('Verify your email first');

      // Replace this with your Paystack public key
      const PAYSTACK_PUBLIC_KEY = 'pk_test_REPLACE_WITH_YOUR_KEY';
      if(PAYSTACK_PUBLIC_KEY.includes('REPLACE')) return alert('Add your Paystack public key in this file (payment.html)');

      // amount in kobo
      const amountKobo = 100 * 100;

      const handler = PaystackPop.setup({
        key: PAYSTACK_PUBLIC_KEY,
        email: user.email,
        amount: amountKobo,
        currency: 'NGN',
        ref: 'SEARCH-'+Math.floor(Math.random()*1000000000),
        metadata: { custom_fields: [{ display_name: user.displayName || user.email, variable_name: "userId", value: user.uid }] },
        callback: function(response){
          document.getElementById('pay-status').style.display='block';
          document.getElementById('pay-status').textContent = 'Payment received (pending verification). Verifying...';

          // record payments doc
          const db = firebase.firestore();
          db.collection('payments').add({
            uid: user.uid,
            ref: response.reference,
            amount: 100,
            plan: 'daily',
            status: 'pending',
            ts: firebase.firestore.FieldValue.serverTimestamp()
          }).then(()=>{
            alert('Payment recorded. Will verify shortly.');
            // listen for user's paidDate
            const uref = db.collection('users').doc(user.uid);
            const unsub = uref.onSnapshot(snap => {
              const d = snap.data();
              const today = new Date().toISOString().slice(0,10);
              if(d && d.paidDate === today){
                unsub();
                alert('Payment verified — access granted for today');
                location.href='dashboard.html';
              }
            });
          }).catch(e=>{
            alert('Failed to record payment. Contact support.');
            console.error(e);
          });
        },
        onClose: function(){
          // user closed
        }
      });
      handler.openIframe();
    });
  </script>
</body>
</html>
